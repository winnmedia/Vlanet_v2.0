name: ğŸ” Deploy Preview & Testing

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [recovery-20250731, main]

env:
  NODE_VERSION: '18'

jobs:
  # ğŸ” ë³€ê²½ì‚¬í•­ ë¶„ì„
  analyze-changes:
    name: ğŸ” Change Impact Analysis
    runs-on: ubuntu-latest
    outputs:
      has_frontend_changes: ${{ steps.changes.outputs.frontend }}
      has_config_changes: ${{ steps.changes.outputs.config }}
      has_dependency_changes: ${{ steps.changes.outputs.dependencies }}
      risk_level: ${{ steps.risk.outputs.level }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“Š Detect File Changes
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            frontend:
              - 'src/**'
              - 'pages/**'
              - 'styles/**'
              - 'public/**'
            config:
              - 'next.config.js'
              - 'package.json'
              - '.env*'
              - 'vercel.json'
            dependencies:
              - 'package-lock.json'
              - 'yarn.lock'

      - name: âš–ï¸ Assess Risk Level
        id: risk
        run: |
          RISK_LEVEL="low"
          
          # ì„¤ì • íŒŒì¼ ë³€ê²½ ì‹œ ì¤‘ê°„ ìœ„í—˜ë„
          if [ "${{ steps.changes.outputs.config }}" == "true" ]; then
            RISK_LEVEL="medium"
          fi
          
          # ì˜ì¡´ì„± ë³€ê²½ ì‹œ ë†’ì€ ìœ„í—˜ë„
          if [ "${{ steps.changes.outputs.dependencies }}" == "true" ]; then
            RISK_LEVEL="high"
          fi
          
          echo "level=${RISK_LEVEL}" >> $GITHUB_OUTPUT
          echo "ğŸ¯ Risk Level: ${RISK_LEVEL}"

  # ğŸ—ï¸ í”„ë¦¬ë·° ë¹Œë“œ
  build-preview:
    name: ğŸ—ï¸ Build Preview
    runs-on: ubuntu-latest
    needs: analyze-changes
    if: needs.analyze-changes.outputs.has_frontend_changes == 'true' || needs.analyze-changes.outputs.has_config_changes == 'true'
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # PRìš© ìµœì í™”ëœ ìºì‹±
      - name: ğŸ“¦ PR Build Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
            .next/cache
          key: pr-build-${{ github.event.pull_request.head.sha }}-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            pr-build-${{ github.event.pull_request.base.sha }}-${{ hashFiles('package-lock.json') }}
            build-${{ runner.os }}-node${{ env.NODE_VERSION }}-${{ hashFiles('package-lock.json') }}

      - name: ğŸ“¥ Install dependencies
        run: |
          npm ci --prefer-offline --no-audit
        env:
          HUSKY: 0

      # í”„ë¦¬ë·° ì „ìš© í™˜ê²½ë³€ìˆ˜ ì„¤ì •
      - name: ğŸ”§ Configure Preview Environment
        run: |
          echo "NEXT_PUBLIC_API_URL=https://videoplanet.up.railway.app" >> .env.local
          echo "NEXT_PUBLIC_ENV=preview" >> .env.local
          echo "NEXT_PUBLIC_PR_NUMBER=${{ github.event.pull_request.number }}" >> .env.local

      - name: ğŸ—ï¸ Build Preview
        run: |
          echo "::group::Preview Build Process"
          npm run build:vercel
          echo "::endgroup::"
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1

      # ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì €ì¥
      - name: ğŸ“¤ Upload Preview Build
        uses: actions/upload-artifact@v4
        with:
          name: preview-build-${{ github.event.pull_request.head.sha }}
          path: |
            .next
            public
          retention-days: 7

      # ë¹Œë“œ ì„±ëŠ¥ ë¦¬í¬íŠ¸
      - name: ğŸ“Š Build Performance Report
        run: |
          echo "## ğŸ—ï¸ Preview Build Report" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build Time | $(date -d@$SECONDS -u +%M:%S) |" >> $GITHUB_STEP_SUMMARY
          echo "| Bundle Size | $(du -sh .next | cut -f1) |" >> $GITHUB_STEP_SUMMARY
          echo "| Static Files | $(find .next/static -type f | wc -l) files |" >> $GITHUB_STEP_SUMMARY

  # ğŸ§ª í”„ë¦¬ë·° í…ŒìŠ¤íŠ¸
  test-preview:
    name: ğŸ§ª Preview Testing
    runs-on: ubuntu-latest
    needs: build-preview
    strategy:
      matrix:
        test-suite: [unit, integration, e2e-critical]
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline
        env:
          HUSKY: 0

      # ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      - name: ğŸ“¥ Download Preview Build
        uses: actions/download-artifact@v4
        with:
          name: preview-build-${{ github.event.pull_request.head.sha }}

      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ë§¤íŠ¸ë¦­ìŠ¤ ê¸°ë°˜)
      - name: ğŸ§ª Run ${{ matrix.test-suite }} Tests
        run: |
          case "${{ matrix.test-suite }}" in
            unit)
              echo "Running unit tests..."
              npm run test:unit || echo "No unit tests configured"
              ;;
            integration)
              echo "Running integration tests..."
              npm start &
              sleep 10
              node deployment-test.js
              ;;
            e2e-critical)
              echo "Running critical path E2E tests..."
              if [ -d "tests/e2e" ]; then
                npx playwright install --with-deps chromium
                npm start &
                sleep 15
                npx playwright test tests/e2e/critical-path.spec.js
              else
                echo "E2E tests not configured"
              fi
              ;;
          esac
        timeout-minutes: 10

      # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
      - name: ğŸ“Š Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.test-suite }}
          path: |
            test-results/
            playwright-report/
          retention-days: 7

  # ğŸš€ Vercel í”„ë¦¬ë·° ë°°í¬
  deploy-preview:
    name: ğŸš€ Deploy to Vercel Preview
    runs-on: ubuntu-latest
    needs: [build-preview, test-preview]
    if: success()
    environment:
      name: preview
      url: ${{ steps.deploy.outputs.preview-url }}
    steps:
      - uses: actions/checkout@v4

      # Vercel í”„ë¦¬ë·° ë°°í¬
      - name: ğŸš€ Deploy Preview to Vercel
        id: deploy
        uses: amondnet/vercel-action@v25
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          github-comment: true
          working-directory: ./

      # ë°°í¬ URL ì €ì¥
      - name: ğŸ’¾ Save Preview URL
        run: |
          echo "PREVIEW_URL=${{ steps.deploy.outputs.preview-url }}" >> $GITHUB_ENV
          echo "Preview URL: ${{ steps.deploy.outputs.preview-url }}"

  # ğŸ” í”„ë¦¬ë·° ê²€ì¦
  verify-preview:
    name: ğŸ” Verify Preview Deployment
    runs-on: ubuntu-latest
    needs: deploy-preview
    steps:
      - uses: actions/checkout@v4

      # í”„ë¦¬ë·° í—¬ìŠ¤ì²´í¬
      - name: ğŸ¥ Preview Health Check
        run: |
          PREVIEW_URL="${{ needs.deploy-preview.outputs.preview-url }}"
          
          echo "::group::Preview Health Check"
          echo "Testing preview URL: ${PREVIEW_URL}"
          
          # ê¸°ë³¸ ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
          curl -f "${PREVIEW_URL}" || exit 1
          echo "âœ… Preview site is accessible"
          
          # ì£¼ìš” ê²½ë¡œ í…ŒìŠ¤íŠ¸
          for path in "" "/login" "/signup"; do
            echo "Testing ${PREVIEW_URL}${path}"
            if curl -f -s "${PREVIEW_URL}${path}" > /dev/null; then
              echo "âœ… ${path} - OK"
            else
              echo "âŒ ${path} - Failed"
            fi
          done
          echo "::endgroup::"

      # Lighthouse í”„ë¦¬ë·° í…ŒìŠ¤íŠ¸
      - name: ğŸŒ Lighthouse Preview Test
        uses: treosh/lighthouse-ci-action@v12
        with:
          urls: |
            ${{ needs.deploy-preview.outputs.preview-url }}
          configPath: './lighthouse.config.js'
          uploadArtifacts: true
          temporaryPublicStorage: true
        continue-on-error: true

  # ğŸ“ PR ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
  update-pr-comment:
    name: ğŸ“ Update PR Comment
    runs-on: ubuntu-latest
    needs: [analyze-changes, verify-preview]
    if: always()
    steps:
      - name: ğŸ“ Create PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            // ê¸°ì¡´ ë´‡ ì½”ë©˜íŠ¸ ì°¾ê¸°
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('ğŸ” Preview Deployment Report')
            );
            
            const riskLevel = "${{ needs.analyze-changes.outputs.risk_level }}";
            const riskEmoji = riskLevel === 'high' ? 'ğŸ”´' : riskLevel === 'medium' ? 'ğŸŸ¡' : 'ğŸŸ¢';
            
            const commentBody = `
            ## ğŸ” Preview Deployment Report
            
            ### ğŸ“Š Change Analysis
            - **Risk Level**: ${riskEmoji} ${riskLevel.toUpperCase()}
            - **Frontend Changes**: ${{ needs.analyze-changes.outputs.has_frontend_changes == 'true' ? 'âœ…' : 'âŒ' }}
            - **Config Changes**: ${{ needs.analyze-changes.outputs.has_config_changes == 'true' ? 'âœ…' : 'âŒ' }}
            - **Dependency Changes**: ${{ needs.analyze-changes.outputs.has_dependency_changes == 'true' ? 'âœ…' : 'âŒ' }}
            
            ### ğŸš€ Deployment Status
            ${{ needs.verify-preview.result == 'success' ? 'âœ… Preview deployed successfully' : 'âŒ Preview deployment failed' }}
            
            ### ğŸ”— Links
            - ğŸŒ [Preview Site](${{ needs.deploy-preview.outputs.preview-url }})
            - ğŸ” [Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### ğŸ§ª Test Results
            - Build: ${{ needs.build-preview.result == 'success' ? 'âœ…' : 'âŒ' }}
            - Tests: ${{ needs.test-preview.result == 'success' ? 'âœ…' : 'âŒ' }}
            - Verification: ${{ needs.verify-preview.result == 'success' ? 'âœ…' : 'âŒ' }}
            
            ---
            *Updated at: ${new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})}*
            `;
            
            if (botComment) {
              // ê¸°ì¡´ ì½”ë©˜íŠ¸ ì—…ë°ì´íŠ¸
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // ìƒˆ ì½”ë©˜íŠ¸ ìƒì„±
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }