name: ğŸ“¢ Smart Notification System

on:
  workflow_run:
    workflows: [
      "ğŸš€ VideoPlanet CI/CD Pipeline",
      "ğŸ›¡ï¸ Security Scan Pipeline",
      "ğŸ“Š Performance Monitoring & Optimization"
    ]
    types: [completed]
  push:
    branches: [recovery-20250731, main]
    tags: ['v*']
  pull_request:
    types: [opened, closed, ready_for_review]
  deployment_status:
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ ì£¼ê°„ ë¦¬í¬íŠ¸ (KST 18ì‹œ)
    - cron: '0 9 * * 1'

jobs:
  # ğŸ¯ ìƒí™©ë³„ ìŠ¤ë§ˆíŠ¸ ì•Œë¦¼
  smart-notifications:
    name: ğŸ¯ Context-Aware Notifications
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # ì›Œí¬í”Œë¡œìš° ìƒíƒœ ë¶„ì„
      - name: ğŸ“Š Analyze Workflow Status
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            const context = github.context;
            const { workflow_run, pull_request, deployment } = context.payload;
            
            let notificationLevel = 'info';
            let emoji = 'ğŸ”µ';
            let shouldNotify = false;
            let message = '';
            let details = '';
            
            // ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì™„ë£Œ
            if (workflow_run) {
              const { name, conclusion, html_url } = workflow_run;
              shouldNotify = true;
              
              if (conclusion === 'success') {
                emoji = 'âœ…';
                notificationLevel = 'success';
                message = `${name} ì„±ê³µ`;
                details = `ëª¨ë“  ì‘ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`;
              } else if (conclusion === 'failure') {
                emoji = 'âŒ';
                notificationLevel = 'error';
                message = `${name} ì‹¤íŒ¨`;
                details = `ì›Œí¬í”Œë¡œìš°ì—ì„œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.`;
              } else if (conclusion === 'cancelled') {
                emoji = 'âš ï¸';
                notificationLevel = 'warning';
                message = `${name} ì·¨ì†Œë¨`;
                details = `ì›Œí¬í”Œë¡œìš°ê°€ ì‚¬ìš©ìì— ì˜í•´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`;
              }
            }
            
            // PR ìƒíƒœ ë³€ê²½
            if (pull_request) {
              shouldNotify = true;
              const { action, number, title, user } = pull_request;
              
              if (action === 'opened') {
                emoji = 'ğŸ”€';
                message = `ìƒˆ PR ìƒì„±: #${number}`;
                details = `${user.login}ë‹˜ì´ "${title}" PRì„ ìƒì„±í–ˆìŠµë‹ˆë‹¤.`;
              } else if (action === 'closed' && pull_request.merged) {
                emoji = 'ğŸ‰';
                notificationLevel = 'success';
                message = `PR ë¨¸ì§€ ì™„ë£Œ: #${number}`;
                details = `"${title}" PRì´ main ë¸Œëœì¹˜ì— ë¨¸ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.`;
              } else if (action === 'ready_for_review') {
                emoji = 'ğŸ‘€';
                message = `PR ë¦¬ë·° ìš”ì²­: #${number}`;
                details = `"${title}" PRì´ ë¦¬ë·°ë¥¼ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤.`;
              }
            }
            
            // ë°°í¬ ìƒíƒœ
            if (deployment) {
              shouldNotify = true;
              const { state, environment } = deployment;
              
              if (state === 'success') {
                emoji = 'ğŸš€';
                notificationLevel = 'success';
                message = `${environment} ë°°í¬ ì„±ê³µ`;
                details = `í”„ë¡œë•ì…˜ í™˜ê²½ì— ì„±ê³µì ìœ¼ë¡œ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.`;
              } else if (state === 'failure') {
                emoji = 'ğŸš¨';
                notificationLevel = 'error';
                message = `${environment} ë°°í¬ ì‹¤íŒ¨`;
                details = `ë°°í¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.`;
              }
            }
            
            // íƒœê·¸ ë¦´ë¦¬ì¦ˆ
            if (context.ref && context.ref.startsWith('refs/tags/v')) {
              const version = context.ref.replace('refs/tags/', '');
              shouldNotify = true;
              emoji = 'ğŸ';
              notificationLevel = 'success';
              message = `ìƒˆ ë²„ì „ ë¦´ë¦¬ì¦ˆ: ${version}`;
              details = `VideoPlanet ${version}ì´ ë¦´ë¦¬ì¦ˆë˜ì—ˆìŠµë‹ˆë‹¤.`;
            }
            
            // ì¶œë ¥ ë³€ìˆ˜ ì„¤ì •
            core.setOutput('should_notify', shouldNotify);
            core.setOutput('level', notificationLevel);
            core.setOutput('emoji', emoji);
            core.setOutput('message', message);
            core.setOutput('details', details);
            core.setOutput('url', workflow_run?.html_url || pull_request?.html_url || '');
            
            return {
              shouldNotify,
              notificationLevel,
              emoji,
              message,
              details
            };

      # Slack ì•Œë¦¼ ì „ì†¡
      - name: ğŸ“² Send Slack Notification
        if: steps.analyze.outputs.should_notify == 'true'
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ steps.analyze.outputs.level }}
          custom_payload: |
            {
              "text": "${{ steps.analyze.outputs.emoji }} VideoPlanet ì•Œë¦¼",
              "attachments": [
                {
                  "color": "${{ steps.analyze.outputs.level == 'success' && 'good' || steps.analyze.outputs.level == 'error' && 'danger' || 'warning' }}",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "${{ steps.analyze.outputs.message }}"
                      }
                    },
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "${{ steps.analyze.outputs.details }}"
                      }
                    },
                    {
                      "type": "context",
                      "elements": [
                        {
                          "type": "mrkdwn",
                          "text": "ğŸŒ ë¸Œëœì¹˜: `${{ github.ref_name }}`\nğŸ“ ì»¤ë°‹: `${{ github.sha }}`.substring(0, 7)\nâ° ì‹œê°„: ${{ github.event.head_commit.timestamp }}"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # Discord ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      - name: ğŸ® Send Discord Notification
        if: steps.analyze.outputs.should_notify == 'true' && secrets.DISCORD_WEBHOOK_URL
        uses: Ilshidur/action-discord@master
        with:
          args: |
            ${{ steps.analyze.outputs.emoji }} **VideoPlanet ì•Œë¦¼**
            
            **${{ steps.analyze.outputs.message }}**
            ${{ steps.analyze.outputs.details }}
            
            ğŸŒ ë¸Œëœì¹˜: `${{ github.ref_name }}`
            ğŸ“ ì»¤ë°‹: `${{ github.sha }}`
            â° ì‹œê°„: ${{ github.event.head_commit.timestamp }}
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}

  # ğŸ“Š ì£¼ê°„ ë¦¬í¬íŠ¸ ìƒì„±
  weekly-report:
    name: ğŸ“Š Weekly Development Report
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 9 * * 1'
    steps:
      - uses: actions/checkout@v4

      # ì§€ë‚œ ì£¼ í™œë™ ë¶„ì„
      - name: ğŸ“ˆ Analyze Weekly Activity
        uses: actions/github-script@v7
        with:
          script: |
            const { Octokit } = require('@octokit/rest');
            const octokit = new Octokit({ auth: process.env.GITHUB_TOKEN });
            
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            
            // ì§€ë‚œ ì£¼ ë‚ ì§œ ê³„ì‚°
            const lastWeek = new Date();
            lastWeek.setDate(lastWeek.getDate() - 7);
            const lastWeekISO = lastWeek.toISOString();
            
            try {
              // PR í™œë™ ë¶„ì„
              const { data: prs } = await octokit.rest.pulls.list({
                owner,
                repo,
                state: 'all',
                since: lastWeekISO
              });
              
              // ì»¤ë°‹ í™œë™ ë¶„ì„
              const { data: commits } = await octokit.rest.repos.listCommits({
                owner,
                repo,
                since: lastWeekISO
              });
              
              // ì´ìŠˆ í™œë™ ë¶„ì„
              const { data: issues } = await octokit.rest.issues.listForRepo({
                owner,
                repo,
                since: lastWeekISO,
                state: 'all'
              });
              
              // ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ë¶„ì„
              const { data: workflowRuns } = await octokit.rest.actions.listWorkflowRunsForRepo({
                owner,
                repo,
                created: `>=${lastWeekISO}`
              });
              
              // í†µê³„ ê³„ì‚°
              const stats = {
                totalPRs: prs.length,
                mergedPRs: prs.filter(pr => pr.merged_at).length,
                totalCommits: commits.length,
                totalIssues: issues.length,
                closedIssues: issues.filter(issue => issue.closed_at).length,
                totalWorkflowRuns: workflowRuns.total_count,
                successfulRuns: workflowRuns.workflow_runs.filter(run => run.conclusion === 'success').length,
                failedRuns: workflowRuns.workflow_runs.filter(run => run.conclusion === 'failure').length
              };
              
              // ì£¼ê°„ ë¦¬í¬íŠ¸ ìƒì„±
              const report = `
              ## ğŸ“Š VideoPlanet ì£¼ê°„ ê°œë°œ ë¦¬í¬íŠ¸
              
              ### ğŸ—“ï¸ ${lastWeek.toLocaleDateString('ko-KR')} ~ ${new Date().toLocaleDateString('ko-KR')}
              
              ### ğŸ“ˆ ê°œë°œ í™œë™ ìš”ì•½
              - ğŸ“ **ì»¤ë°‹**: ${stats.totalCommits}ê°œ
              - ğŸ”€ **Pull Request**: ${stats.totalPRs}ê°œ (ë¨¸ì§€: ${stats.mergedPRs}ê°œ)
              - ğŸ¯ **ì´ìŠˆ**: ${stats.totalIssues}ê°œ (í•´ê²°: ${stats.closedIssues}ê°œ)
              
              ### ğŸš€ CI/CD í˜„í™©
              - âœ… **ì„±ê³µí•œ ë¹Œë“œ**: ${stats.successfulRuns}ê°œ
              - âŒ **ì‹¤íŒ¨í•œ ë¹Œë“œ**: ${stats.failedRuns}ê°œ
              - ğŸ“Š **ì„±ê³µë¥ **: ${Math.round((stats.successfulRuns / (stats.successfulRuns + stats.failedRuns)) * 100)}%
              
              ### ğŸ¯ ì£¼ìš” ì„±ê³¼
              ${stats.mergedPRs > 0 ? `- ${stats.mergedPRs}ê°œì˜ ê¸°ëŠ¥ ê°œì„  ë° ë²„ê·¸ ìˆ˜ì • ì™„ë£Œ` : ''}
              ${stats.closedIssues > 0 ? `- ${stats.closedIssues}ê°œì˜ ì´ìŠˆ í•´ê²°` : ''}
              ${stats.failedRuns === 0 ? `- ëª¨ë“  CI/CD íŒŒì´í”„ë¼ì¸ ì„±ê³µì  ì‹¤í–‰` : ''}
              
              ---
              *ìë™ ìƒì„±ëœ ì£¼ê°„ ë¦¬í¬íŠ¸ì…ë‹ˆë‹¤.*
              `;
              
              console.log(report);
              
              // í™˜ê²½ ë³€ìˆ˜ë¡œ ë¦¬í¬íŠ¸ ì „ë‹¬
              require('fs').writeFileSync('weekly-report.md', report);
              core.exportVariable('WEEKLY_REPORT', report);
              
            } catch (error) {
              console.error('ì£¼ê°„ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨:', error);
              core.setFailed('ì£¼ê°„ ë¦¬í¬íŠ¸ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ì£¼ê°„ ë¦¬í¬íŠ¸ Slack ì „ì†¡
      - name: ğŸ“Š Send Weekly Report to Slack
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          custom_payload: |
            {
              "text": "ğŸ“Š VideoPlanet ì£¼ê°„ ê°œë°œ ë¦¬í¬íŠ¸",
              "attachments": [
                {
                  "color": "good",
                  "blocks": [
                    {
                      "type": "section",
                      "text": {
                        "type": "mrkdwn",
                        "text": "```\n${{ env.WEEKLY_REPORT }}\n```"
                      }
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      # ì£¼ê°„ ë¦¬í¬íŠ¸ ì €ì¥
      - name: ğŸ“ Archive Weekly Report
        uses: actions/upload-artifact@v4
        with:
          name: weekly-report-${{ github.run_number }}
          path: weekly-report.md
          retention-days: 90

  # ğŸš¨ ê¸´ê¸‰ ì•Œë¦¼ (ì‹¤íŒ¨ ì‹œ)
  emergency-alert:
    name: ğŸš¨ Emergency Alert System
    runs-on: ubuntu-latest
    if: failure() && github.ref == 'refs/heads/recovery-20250731'
    steps:
      - name: ğŸš¨ Critical Failure Alert
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          custom_payload: |
            {
              "text": "ğŸš¨ URGENT: VideoPlanet í”„ë¡œë•ì…˜ ë¬¸ì œ ë°œìƒ!",
              "attachments": [
                {
                  "color": "danger",
                  "blocks": [
                    {
                      "type": "header",
                      "text": {
                        "type": "plain_text",
                        "text": "ğŸš¨ í”„ë¡œë•ì…˜ í™˜ê²½ ë¬¸ì œ ê°ì§€"
                      }
                    },
                    {
                      "type": "section",
                      "fields": [
                        {
                          "type": "mrkdwn",
                          "text": "*ë¸Œëœì¹˜:* `recovery-20250731`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*ì»¤ë°‹:* `${{ github.sha }}`"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*ì‹œê°„:* ${{ github.event.head_commit.timestamp }}"
                        },
                        {
                          "type": "mrkdwn",
                          "text": "*ì‘ì—…ì:* ${{ github.actor }}"
                        }
                      ]
                    },
                    {
                      "type": "actions",
                      "elements": [
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "ì›Œí¬í”Œë¡œìš° í™•ì¸"
                          },
                          "url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                        },
                        {
                          "type": "button",
                          "text": {
                            "type": "plain_text",
                            "text": "ì‚¬ì´íŠ¸ í™•ì¸"
                          },
                          "url": "https://vlanet.net"
                        }
                      ]
                    }
                  ]
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}