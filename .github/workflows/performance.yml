name: ğŸ“Š Performance Monitoring & Optimization

on:
  push:
    branches: [ recovery-20250731, main ]
  pull_request:
    branches: [ recovery-20250731, main ]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 6ì‹œ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ (KST 15ì‹œ)
    - cron: '0 6 * * *'
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  LIGHTHOUSE_CI_TOKEN: ${{ secrets.LIGHTHOUSE_CI_TOKEN }}

jobs:
  # ğŸ—ï¸ ë¹Œë“œ ì„±ëŠ¥ ë¶„ì„
  build-performance:
    name: ğŸ—ï¸ Build Performance Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: ğŸ—ï¸ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # ê³ ê¸‰ ìºì‹± ì „ëµ (2025 ìµœì í™”)
      - name: ğŸš€ Performance-Optimized Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.npm
            node_modules
            .next/cache
          key: perf-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-${{ github.sha }}
          restore-keys: |
            perf-${{ runner.os }}-${{ hashFiles('package-lock.json') }}-
            perf-${{ runner.os }}-

      - name: ğŸ“¥ Install dependencies with timing
        run: |
          echo "::group::Dependency Installation Performance"
          time npm ci --prefer-offline --no-audit
          echo "::endgroup::"
        env:
          HUSKY: 0

      # ë¹Œë“œ ì„±ëŠ¥ ì¸¡ì •
      - name: â±ï¸ Build Performance Test
        run: |
          echo "::group::Build Performance Analysis"
          
          # ë¹Œë“œ ì‹œê°„ ì¸¡ì •
          echo "ğŸ—ï¸ Starting build performance test..."
          START_TIME=$(date +%s)
          
          npm run build:vercel
          
          END_TIME=$(date +%s)
          BUILD_TIME=$((END_TIME - START_TIME))
          
          echo "â±ï¸ Build completed in: ${BUILD_TIME} seconds"
          echo "BUILD_TIME=${BUILD_TIME}" >> $GITHUB_ENV
          
          # ë²ˆë“¤ í¬ê¸° ë¶„ì„
          echo "ğŸ“Š Analyzing bundle sizes..."
          find .next/static -name "*.js" -exec du -sh {} + | sort -hr > bundle-sizes.txt
          cat bundle-sizes.txt
          
          # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë¶„ì„
          echo "ğŸ’¾ Memory usage during build:"
          free -h
          
          echo "::endgroup::"

      # ë²ˆë“¤ ë¶„ì„ê¸° ì‹¤í–‰
      - name: ğŸ“ˆ Bundle Analyzer
        run: |
          echo "::group::Bundle Analysis"
          ANALYZE=true npm run build
          echo "::endgroup::"
        continue-on-error: true

      # ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
      - name: ğŸ“Š Collect Performance Metrics
        run: |
          echo "::group::Performance Metrics Collection"
          
          # JavaScript ë²ˆë“¤ í¬ê¸°
          MAIN_BUNDLE_SIZE=$(find .next/static/chunks -name "*.js" -exec wc -c {} + | tail -1 | awk '{print $1}')
          CSS_BUNDLE_SIZE=$(find .next/static/css -name "*.css" -exec wc -c {} + | tail -1 | awk '{print $1}' || echo "0")
          
          echo "ğŸ“¦ Main JS Bundle: $(($MAIN_BUNDLE_SIZE / 1024)) KB"
          echo "ğŸ¨ CSS Bundle: $(($CSS_BUNDLE_SIZE / 1024)) KB"
          echo "â±ï¸ Build Time: $BUILD_TIME seconds"
          
          # GitHubì— ë©”íŠ¸ë¦­ ì „ë‹¬
          echo "MAIN_BUNDLE_KB=$(($MAIN_BUNDLE_SIZE / 1024))" >> $GITHUB_ENV
          echo "CSS_BUNDLE_KB=$(($CSS_BUNDLE_SIZE / 1024))" >> $GITHUB_ENV
          
          echo "::endgroup::"

      # ì„±ëŠ¥ ë³´ê³ ì„œ ìƒì„±
      - name: ğŸ“‹ Generate Performance Report
        uses: actions/github-script@v7
        with:
          script: |
            const buildTime = process.env.BUILD_TIME;
            const mainBundleKB = process.env.MAIN_BUNDLE_KB;
            const cssBundleKB = process.env.CSS_BUNDLE_KB;
            
            const report = `
            ## ğŸš€ Build Performance Report
            
            ### â±ï¸ Build Metrics
            - **Build Time**: ${buildTime} seconds
            - **Main JS Bundle**: ${mainBundleKB} KB
            - **CSS Bundle**: ${cssBundleKB} KB
            - **Node.js Version**: ${process.env.NODE_VERSION}
            - **Build Date**: ${new Date().toISOString()}
            
            ### ğŸ“Š Performance Status
            ${buildTime < 120 ? 'ğŸŸ¢ Excellent' : buildTime < 300 ? 'ğŸŸ¡ Good' : 'ğŸ”´ Needs Optimization'}
            
            ### ğŸ¯ Optimization Suggestions
            ${mainBundleKB > 500 ? '- Consider code splitting for large bundles\n' : ''}
            ${buildTime > 300 ? '- Review dependencies and build process\n' : ''}
            - Enable incremental builds for faster CI
            - Use build cache for repeated builds
            `;
            
            console.log(report);
            core.summary.addRaw(report);
            await core.summary.write();

      # ì„±ëŠ¥ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: ğŸ“¤ Upload Performance Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: performance-report-${{ github.sha }}
          path: |
            bundle-sizes.txt
            .next/analyze/
          retention-days: 30

  # ğŸŒ Lighthouse ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
  lighthouse-performance:
    name: ğŸŒ Lighthouse Performance Test
    runs-on: ubuntu-latest
    needs: build-performance
    if: github.event_name != 'schedule' # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ ì‹œ ì œì™¸
    steps:
      - uses: actions/checkout@v4

      - name: ğŸ—ï¸ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci --prefer-offline
        env:
          HUSKY: 0

      # í”„ë¡œë•ì…˜ ë¹Œë“œ
      - name: ğŸ—ï¸ Build for production
        run: npm run build:vercel

      # ë¡œì»¬ ì„œë²„ ì‹œì‘
      - name: ğŸš€ Start production server
        run: |
          npm start &
          echo "SERVER_PID=$!" >> $GITHUB_ENV
          sleep 10
        timeout-minutes: 2

      # Lighthouse CI ì‹¤í–‰
      - name: ğŸ” Lighthouse CI
        uses: treosh/lighthouse-ci-action@v12
        with:
          configPath: './lighthouse.config.js'
          uploadArtifacts: true
          temporaryPublicStorage: true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      # Web Vitals ì¸¡ì •
      - name: ğŸ“Š Web Vitals Assessment
        uses: actions/github-script@v7
        with:
          script: |
            // Web Vitals ì„ê³„ê°’
            const thresholds = {
              fcp: 1800,      // First Contentful Paint
              lcp: 2500,      // Largest Contentful Paint
              cls: 0.1,       // Cumulative Layout Shift
              fid: 100,       // First Input Delay
              tbt: 200        // Total Blocking Time
            };
            
            console.log('ğŸ¯ Web Vitals Thresholds:');
            console.log('- FCP (First Contentful Paint): < 1.8s');
            console.log('- LCP (Largest Contentful Paint): < 2.5s');
            console.log('- CLS (Cumulative Layout Shift): < 0.1');
            console.log('- FID (First Input Delay): < 100ms');
            console.log('- TBT (Total Blocking Time): < 200ms');

      # ì„œë²„ ì •ë¦¬
      - name: ğŸ§¹ Cleanup server
        run: |
          if [ -n "$SERVER_PID" ]; then
            kill $SERVER_PID || true
          fi

  # ğŸ”„ ì„±ëŠ¥ íšŒê·€ í…ŒìŠ¤íŠ¸
  performance-regression:
    name: ğŸ”„ Performance Regression Test
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ì´ì „ ì„±ëŠ¥ ë°ì´í„°ì™€ ë¹„êµ
      - name: ğŸ“Š Performance Comparison
        uses: actions/github-script@v7
        with:
          script: |
            // PRì—ì„œ ì„±ëŠ¥ íšŒê·€ ê²€ì‚¬ ë¡œì§
            const { execSync } = require('child_process');
            
            try {
              // ê¸°ì¤€ ë¸Œëœì¹˜ë¡œ ì²´í¬ì•„ì›ƒí•˜ì—¬ ë¹Œë“œ ì‹œê°„ ì¸¡ì •
              console.log('ğŸ“Š Comparing performance with base branch...');
              
              // í˜„ì¬ PRì˜ ë³€ê²½ì‚¬í•­ ë¶„ì„
              const changedFiles = execSync('git diff --name-only HEAD~1').toString().split('\n').filter(f => f);
              const hasSignificantChanges = changedFiles.some(file => 
                file.includes('package.json') || 
                file.includes('next.config.js') ||
                file.includes('src/') ||
                file.includes('pages/')
              );
              
              if (hasSignificantChanges) {
                core.notice('ğŸ” Significant changes detected - performance impact analysis recommended');
              } else {
                core.notice('âœ… Minor changes detected - minimal performance impact expected');
              }
              
            } catch (error) {
              console.log('Performance comparison skipped:', error.message);
            }

  # ğŸ“ˆ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ
  performance-dashboard:
    name: ğŸ“ˆ Performance Dashboard Update
    runs-on: ubuntu-latest
    needs: [build-performance, lighthouse-performance]
    if: always() && github.ref == 'refs/heads/recovery-20250731'
    steps:
      - uses: actions/checkout@v4

      # ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
      - name: ğŸ“¥ Collect Performance Data
        uses: actions/download-artifact@v4
        with:
          pattern: performance-report-*
          merge-multiple: true

      # ì„±ëŠ¥ íŠ¸ë Œë“œ ë¶„ì„
      - name: ğŸ“Š Performance Trend Analysis
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const performanceData = {
              timestamp: new Date().toISOString(),
              buildTime: process.env.BUILD_TIME || 'N/A',
              mainBundleKB: process.env.MAIN_BUNDLE_KB || 'N/A',
              cssBundleKB: process.env.CSS_BUNDLE_KB || 'N/A',
              commit: context.sha.substring(0, 7),
              branch: 'recovery-20250731'
            };
            
            console.log('ğŸ“ˆ Performance Metrics Collected:');
            console.log(JSON.stringify(performanceData, null, 2));
            
            // ì„±ëŠ¥ ì•Œë¦¼ (ì„ê³„ê°’ ì´ˆê³¼ ì‹œ)
            if (performanceData.buildTime > 300) {
              core.warning(`âš ï¸ Build time exceeded 5 minutes: ${performanceData.buildTime}s`);
            }
            
            if (performanceData.mainBundleKB > 1000) {
              core.warning(`âš ï¸ Main bundle size is large: ${performanceData.mainBundleKB}KB`);
            }

      # Slack ì„±ëŠ¥ ì•Œë¦¼
      - name: ğŸ“¢ Performance Status Notification
        if: env.BUILD_TIME > 300
        uses: 8398a7/action-slack@v3
        with:
          status: warning
          text: |
            ğŸ“Š Performance Alert - VideoPlanet Frontend
            ğŸ• Build Time: ${{ env.BUILD_TIME }}s (Target: <300s)
            ğŸ“¦ Bundle Size: ${{ env.MAIN_BUNDLE_KB }}KB
            Commit: ${{ github.sha }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}