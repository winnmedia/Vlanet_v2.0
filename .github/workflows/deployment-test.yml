name: ğŸš€ Deployment Health Check

on:
  push:
    branches: [ main, development ]
  pull_request:
    branches: [ main ]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ, ì˜¤í›„ 6ì‹œ (KST ê¸°ì¤€)
    - cron: '0 0,9 * * *'  # UTC 00:00, 09:00 = KST 09:00, 18:00
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Test Type'
        required: true
        default: 'full'
        type: choice
        options:
        - full
        - quick
        - integration-only

jobs:
  deployment-test:
    name: ğŸ” Deployment Status Test
    runs-on: ubuntu-latest
    
    outputs:
      deployment_status: ${{ steps.deploy_test.outputs.status }}
      success_rate: ${{ steps.deploy_test.outputs.success_rate }}
    
    steps:
    - name: ğŸ“‚ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸŸ¢ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install Dependencies
      run: |
        npm ci
        npm install node-fetch
        
    - name: ğŸ” Run Deployment Tests
      id: deploy_test
      run: |
        echo "ğŸš€ Starting deployment tests..."
        
        # deployment-test.js ì‹¤í–‰ ë° ê²°ê³¼ íŒŒì‹±
        node deployment-test.js > test_output.log 2>&1 || true
        
        # ì„±ê³µë¥  ì¶”ì¶œ
        SUCCESS_RATE=$(grep -oE "ì„±ê³µë¥ : [0-9.]+%" test_output.log | grep -oE "[0-9.]+" || echo "0")
        TOTAL_TESTS=$(grep -oE "ì´ í…ŒìŠ¤íŠ¸: [0-9]+" test_output.log | grep -oE "[0-9]+" || echo "0")
        PASSED_TESTS=$(grep -oE "ì„±ê³µ: [0-9]+ âœ…" test_output.log | grep -oE "[0-9]+" || echo "0")
        FAILED_TESTS=$(grep -oE "ì‹¤íŒ¨: [0-9]+ âŒ" test_output.log | grep -oE "[0-9]+" || echo "0")
        
        echo "success_rate=$SUCCESS_RATE" >> $GITHUB_OUTPUT
        echo "total_tests=$TOTAL_TESTS" >> $GITHUB_OUTPUT
        echo "passed_tests=$PASSED_TESTS" >> $GITHUB_OUTPUT
        echo "failed_tests=$FAILED_TESTS" >> $GITHUB_OUTPUT
        
        # ìƒíƒœ ê²°ì •
        if [ "$SUCCESS_RATE" = "100" ]; then
          echo "status=excellent" >> $GITHUB_OUTPUT
          echo "ğŸ‰ ëª¨ë“  í…ŒìŠ¤íŠ¸ í†µê³¼!"
        elif [ "$(echo "$SUCCESS_RATE >= 90" | bc -l)" = "1" ]; then
          echo "status=good" >> $GITHUB_OUTPUT
          echo "âœ… ëŒ€ë¶€ë¶„ì˜ í…ŒìŠ¤íŠ¸ í†µê³¼"
        elif [ "$(echo "$SUCCESS_RATE >= 80" | bc -l)" = "1" ]; then
          echo "status=warning" >> $GITHUB_OUTPUT
          echo "âš ï¸ ì¼ë¶€ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
        else
          echo "status=critical" >> $GITHUB_OUTPUT
          echo "âŒ ë‹¤ìˆ˜ì˜ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
          exit 1
        fi
        
    - name: ğŸ“‹ Display Test Results
      run: |
        echo "## ğŸ” Deployment Test Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
        echo "| Success Rate | ${{ steps.deploy_test.outputs.success_rate }}% |" >> $GITHUB_STEP_SUMMARY
        echo "| Total Tests | ${{ steps.deploy_test.outputs.total_tests }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Passed | ${{ steps.deploy_test.outputs.passed_tests }} âœ… |" >> $GITHUB_STEP_SUMMARY
        echo "| Failed | ${{ steps.deploy_test.outputs.failed_tests }} âŒ |" >> $GITHUB_STEP_SUMMARY
        echo "| Status | ${{ steps.deploy_test.outputs.status }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # í…ŒìŠ¤íŠ¸ ë¡œê·¸ ì¶œë ¥
        echo "### ğŸ“ Detailed Logs" >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        cat test_output.log >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        
    - name: ğŸ”— Integration Tests
      if: ${{ github.event.inputs.test_type != 'quick' }}
      run: |
        echo "ğŸ§ª Running integration tests..."
        node integration-test.js > integration_output.log 2>&1 || true
        
        echo "### ğŸ§ª Integration Test Results" >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        cat integration_output.log >> $GITHUB_STEP_SUMMARY
        echo "```" >> $GITHUB_STEP_SUMMARY
        
    - name: ğŸ“Š Upload Test Results
      uses: actions/upload-artifact@v4
      with:
        name: deployment-test-results-${{ github.run_number }}
        path: |
          test_output.log
          integration_output.log
          deployment-test-results-*.json
        retention-days: 30
        
    - name: ğŸ’¬ Comment PR Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const successRate = '${{ steps.deploy_test.outputs.success_rate }}';
          const status = '${{ steps.deploy_test.outputs.status }}';
          const totalTests = '${{ steps.deploy_test.outputs.total_tests }}';
          const passedTests = '${{ steps.deploy_test.outputs.passed_tests }}';
          const failedTests = '${{ steps.deploy_test.outputs.failed_tests }}';
          
          const statusEmojis = {
            'excellent': 'ğŸ‰',
            'good': 'âœ…',
            'warning': 'âš ï¸',
            'critical': 'âŒ'
          };
          
          const comment = `## ${statusEmojis[status]} Deployment Test Results
          
          | Metric | Value |
          |--------|-------|
          | ì„±ê³µë¥  | **${successRate}%** |
          | ì´ í…ŒìŠ¤íŠ¸ | ${totalTests} |
          | ì„±ê³µ | ${passedTests} âœ… |
          | ì‹¤íŒ¨ | ${failedTests} âŒ |
          
          ### ğŸ“ Status: ${status}
          
          ${status === 'excellent' ? 'ëª¨ë“  ë°°í¬ í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤! ğŸš€' :
            status === 'good' ? 'ëŒ€ë¶€ë¶„ì˜ í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤. âœ¨' :
            status === 'warning' ? 'ì¼ë¶€ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê²€í† ê°€ í•„ìš”í•©ë‹ˆë‹¤. âš ï¸' :
            'ë‹¤ìˆ˜ì˜ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤! ğŸš¨'}
          
          > ìì„¸í•œ ê²°ê³¼ëŠ” Actions íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš”.`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  notify:
    name: ğŸ“¢ Notification
    runs-on: ubuntu-latest
    needs: deployment-test
    if: always()
    
    steps:
    - name: ğŸš¨ Critical Alert
      if: needs.deployment-test.outputs.deployment_status == 'critical'
      run: |
        echo "ğŸš¨ CRITICAL: Deployment tests failed significantly!"
        echo "Success rate: ${{ needs.deployment-test.outputs.success_rate }}%"
        echo "Immediate attention required!"
        
    - name: âš ï¸ Warning Alert
      if: needs.deployment-test.outputs.deployment_status == 'warning'
      run: |
        echo "âš ï¸ WARNING: Some deployment tests failed."
        echo "Success rate: ${{ needs.deployment-test.outputs.success_rate }}%"
        echo "Review recommended."
        
    - name: âœ… Success Notification
      if: needs.deployment-test.outputs.deployment_status == 'excellent' || needs.deployment-test.outputs.deployment_status == 'good'
      run: |
        echo "âœ… Deployment tests passed successfully!"
        echo "Success rate: ${{ needs.deployment-test.outputs.success_rate }}%"
        echo "All systems operational! ğŸš€"